<html>
<head>
	<link rel="stylesheet" href="kickstart/css/kickstart.css" media="all" /> <!-- KICKSTART -->
	<style type="text/css" media="screen">
		body{
			background-color: #d0e4fe;
		}
		.backWhite{
			background-color: #FFFFFF;
		}
		.loading{
			position: absolute;
			display: none;
			top: 45%;
		    left: 45%;
		    z-index: 90008;
		}
		.blackout{
			background-color: #DDDDDD;
			position: absolute;
			top: 0;
			left: 0;
			height: 100%;
			width: 100%;
			opacity: 0.5;
			z-index: 90001;
		}
		#newTreeName{
			display: none;
			position: absolute;
			top: 40%;
			left: 35%;
			height: 100px;
			width: 300px;
			text-align: center;
			z-index: 90002;
			background-color: #FFFFFF;
			border: 5px groove #9090dd;
		}
		#copyTreeName{
			display: none;
			position: absolute;
			top: 40%;
			left: 35%;
			height: 100px;
			width: 300px;
			text-align: center;
			z-index: 90002;
			background-color: #FFFFFF;
			border: 5px groove #9090dd;
		}
		#notices{
			position: absolute;
			top: 0;
			left: 40%;
			width: 20%;
			text-align: center;
			z-index: 90007;
			cursor: pointer;
		}
		.formElement{
			margin: 5px;
		}
	</style>
	<title>Cloudinator - Inicio</title>
</head>
<body>
	<!-- ELEMENTOS FLOTANTES (inicio) -->
	<div id="notices"></div>

	<div id="newTreeName" class="col_3 column">
		<label for="textName" class="formElement">Nombre: </label>
		<input id="textName" class="formElement" type="text" />
		<button id="buttonName" class="formElement">Crear</button>
		<button id="buttonCancel" class="formElement">Cancelar</button>
	</div>
	<div id="copyTreeName" class="col_3 column" data-copyid="">
		<label for="textNameCopy" class="formElement">Nombre: </label>
		<input id="textNameCopy" class="formElement" type="text" />
		<button id="buttonNameCopy" class="formElement">Crear</button>
		<button id="buttonCancelCopy" class="formElement">Cancelar</button>
	</div>

	<img id="loadingGif" class="loading" src="content/ajax-loader.gif">

	<div class="blackout loading"></div>
	<!-- ELEMENTOS FLOTANTES (fin) -->

	<center>
		<img src="http://nearshoreamericas.com/wp-content/uploads/2010/07/sonda1.jpg" height=200px border=1px>
	</center>
	<br>

	<!-- MENU (inicio) -->
	<div class="col_4 column">
		<ul class="menu vertical">
		<li id="new"><a href="#"><i class="icon-file"></i> Nuevo Subformulario</a></li>
		<li><a href=""><i class="icon-edit"></i> Editar Subformulario</a>
			<ul id="edit">
			</ul>
		</li>
		<li id="new"><a href="#"><i class="icon-file"></i> Nuevo Grafo</a></li>
   		<li><a href=""><i class="icon-copy"></i> Nuevo Grafo a partir de uno ya existente</a>
      		<ul id="copy">
      		</ul>
	    </li> 
		<li><a href=""><i class="icon-share"></i> Recorrer Subformulario</a>
			<ul id="do">
			<li><a href="#">Coming Soon</a></li>
			</ul>
		</li>
		<li><a href=""><i class="icon-wrench"></i> Administracion (DEVELOPMENT ONLY)</a>
			<ul>
			<li><a href="installDB.php">Instalar DB</a></l(i>
			<li><a href="installDatos.php">Instalar Datos (Dummy)</a></li>
			</ul>
		</li>
		</ul>
	</div>
	<!-- MENU (fin) -->

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<script src="kickstart/js/kickstart.js"></script> <!-- KICKSTART -->
	<script>
	function cargarGrafos(){
		
		$.ajax({
			url: 'ajaxTrees.php',
			dataType: 'json',
			timeout: 2500,
			beforeSend: function(){$('.loading').fadeIn();},
			success: function(data){
				$('#copy').empty();
				$('#edit').empty();
				$.each( data, function( i, item ) {
					if(item.deleted == 0){
						$('#copy').append('<li data-id="'+item.id+'"><a href="#">'+item.name+'</a></li>');
						$('#edit').append('<li><a href="cloudinator.html?id='+item.id+'">'+item.name+'</a></li>');
					}
				});
			}
		}).fail(function(data) {
			$('#notices').append('<div class="notice error new"><i class="icon-remove-sign icon-large"></i> Error al acceder a la lista de Grafos<a href="#close" class="icon-remove"></a></div>').hide()
			$('.new').slideDown().removeClass('new');
			$('#copy').append('<li><a href="">ERROR</a></li>');
			$('#edit').append('<li><a href="">ERROR</a></li>');
		}).always(function(){$('.loading').fadeOut();});
	}
	function clonar(){
		
		console.log("listo para clonar");
		
		$('#copyTreeName').slideUp();
		
					$.ajax({
						url: 'ajaxTrees.php',
						dataType: 'json',
						type: 'POST',
						data: {
							name: $('#textNameCopy').val(),
							clonename : $('#copyTreeName').data("copyid")
								},
						timeout: 2500,
						beforeSend: function(){$('.loading').fadeIn();},
						success: function(data){
							console.log(data);
							cargarGrafos();
							$('#notices').append('<div class="notice success new"><i class="icon-ok icon-large"></i> Nuevo Grafo creado exitosamente<a href="#close" class="icon-remove"></a></div>');
							//$('.new').hide().slideDown().removeClass('new');
							//$('#newTreeName').slideDown();
						}
					}).fail(function(data) {
						//$('#notices').append('<div class="notice error new"><i class="icon-remove-sign icon-large"></i> Error al Crear el Nuevo Grafo<a href="#close" class="icon-remove"></a></div>');
						//$('.new').hide().slideDown().removeClass('new');
						window.location.reload();
						console.log( data);
					}).always(function(){$('.loading').fadeOut();});
		
	}
	function enviarForm(){
		$('#newTreeName').slideUp();
		$.ajax({
			url: 'ajaxTrees.php',
			dataType: 'json',
			timeout: 2500,
			beforeSend: function(){$('.loading').fadeIn();},
			success: function(data){
				var checker = 0;
				$.each( data, function( i, item ) {
					if(item.name == $('#textName').val()){
						checker = 1;
					}
				});
				if(checker == 0){
					$.ajax({
						url: 'ajaxTrees.php',
						dataType: 'json',
						type: 'POST',
						data: {name: $('#textName').val()},
						timeout: 2500,
						beforeSend: function(){$('.loading').fadeIn();},
						success: function(data){
							console.log(data);
							cargarGrafos();
							$('#notices').append('<div class="notice success new"><i class="icon-ok icon-large"></i> Nuevo Grafo creado exitosamente<a href="#close" class="icon-remove"></a></div>');
							$('.new').hide().slideDown().removeClass('new');
						}
					}).fail(function(data) {
						//$('#notices').append('<div class="notice error new"><i class="icon-remove-sign icon-large"></i> Error al Crear el Nuevo Grafo<a href="#close" class="icon-remove"></a></div>');
						//$('.new').hide().slideDown().removeClass('new');
						window.location.reload();
						console.log(data);
					}).always(function(){$('.loading').fadeOut();});
				}else{
					$('#loadingGif').fadeOut();
					$('#notices').append('<div class="notice warning new"><i class="icon-warning-sign icon-large"></i> Nombre ocupado<a href="#close" class="icon-remove"></a></div>');
					$('.new').hide().slideDown().removeClass('new');
					$('#newTreeName').slideDown();
				}
			}
		}).fail(function(data) {
			$('#notices').append('<div class="notice error new"><i class="icon-remove-sign icon-large"></i> Error al acceder a la lista de Grafos<a href="#close" class="icon-remove"></a></div>');
			$('.new').hide().slideDown().removeClass('new');
			$('#copy').append('<li><a href="">ERROR</a></li>');
			$('#edit').append('<li><a href="">ERROR</a></li>');
		});
	}
	$(document).ready(function() {

		cargarGrafos();

		$("#copy").on("click", "li", function(event){
			$('#copyTreeName').data("copyid", $(this).text());
			$('#copyTreeName').slideDown();
  			//alert('NO IMPLEMENTADO AUN!\rID: '+$(this).data('id')+' Nombre: '+$(this).text());
  			//hacer llamada por ajax a la db para hacer una copia del arbol existente y que devuelva el nuevo id (POST) y posteriormente redireccionar a cloudinator.html?id=[algo]
  			//tambien hay que preguntar el nuevo nombre!
  			console.log(event);
		});

		$('#new').on('click', function(event){
			$('.blackout').fadeIn();
			$('#newTreeName').slideDown();
			//abrir cuadro de dialogo para elegir nombre (?) o preguntar por el nombre despues de que se crea? (prefieron la primera)
			//hacer llamada por ajax para generar el nuevo arbol en la DB y rescatar la id, para despues ir a cloudinator.html
		});
		$('#buttonCancel').on('click', function(){
			$('#newTreeName').slideUp();
			$('.blackout').fadeOut();
		});
		$("#textName").keypress(function(event) {
			if(event.which == 13){
				enviarForm();
			}
		});
		$('#buttonName').on('click', function(event){
			enviarForm();
		});
		
		
		$('#buttonCancelCopy').on('click', function(){
			$('#copyTreeName').slideUp();
			$('.blackout').fadeOut();
		});
		$("#textNameCopy").keypress(function(event) {
			if(event.which == 13){
				console.log("assds");
				clonar();
			}
		});
		$('#buttonNameCopy').on('click', function(event){
			console.log("assds");
			clonar();
		});

		$('#notices').on('click', '.notice', function(event){
			$(this).slideUp(function(){
				$(this).remove();
			});
		});
	});
	</script>
</body>
</html>